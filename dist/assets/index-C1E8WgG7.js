(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function i(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(o){if(o.ep)return;o.ep=!0;const r=i(o);fetch(o.href,r)}})();const m={SPEED:10,PLAYER_SIZE:48,ROOMS:[{id:1,name:"è¿·è¿­é¦™",video:"è¿·è¿­é¦™.mp4",answers:["è¿·è¿­é¦™","å‘¨æ°ä¼¦"],style:"jazz"},{id:2,name:"é¾™å·é£Ž",video:"é¾™å·é£Ž.mp4",answers:["é¾™å·é£Ž","å‘¨æ°ä¼¦"],style:"pop"},{id:3,name:"æœˆäº®ä»£è¡¨è°çš„å¿ƒ",video:"æœˆäº®ä»£è¡¨è°çš„å¿ƒ.mp4",answers:["æœˆäº®ä»£è¡¨è°çš„å¿ƒ","é™¶å–†"],style:"rnb"},{id:4,name:"åƒå¹´ç­‰ä¸€å›ž",video:"åƒå¹´ç­‰ä¸€å›ž.mp4",answers:["åƒå¹´ç­‰ä¸€å›ž","é«˜èƒœç¾Ž"],style:"classic-cn"},{id:5,name:"ä¸€ç”Ÿæ‰€çˆ±",video:"ä¸€ç”Ÿæ‰€çˆ±.mp4",answers:["ä¸€ç”Ÿæ‰€çˆ±","å¢å† å»·"],style:"hk"},{id:6,name:"æ•¢é—®è·¯åœ¨ä½•æ–¹",video:"æ•¢é—®è·¯åœ¨ä½•æ–¹.mp4",answers:["æ•¢é—®è·¯åœ¨ä½•æ–¹","è’‹å¤§ä¸º"],style:"folk"}],NOTE_SPEED:3,SPAWN_RATE:35},e={currentScene:"lobby",playerPos:{x:window.innerWidth/2,y:window.innerHeight/2},keys:{},isTransitioning:!1,gameStarted:!1,bgm:null,rhythm:{score:0,combo:0,notes:[],frameCount:0,isPlaying:!1,powerUp:"normal",powerUpTimer:0,speedMod:1,freezeTimer:0}},l=document.getElementById("player"),f=document.getElementById("scene-layer"),a={startScreen:document.getElementById("start-screen"),startBtn:document.getElementById("start-btn"),controlsHint:document.getElementById("controls-hint"),rhythmHud:document.getElementById("rhythm-hud"),backBtn:document.getElementById("back-btn"),score:document.getElementById("rhythm-score"),combo:document.getElementById("rhythm-combo"),msg:document.getElementById("rhythm-message"),vControls:document.getElementById("virtual-controls"),keyLeft:document.getElementById("key-left"),keyRight:document.getElementById("key-right"),transition:document.getElementById("transition-overlay"),scoreBoard:document.getElementById("score-board")};function T(){a.startBtn.addEventListener("click",v),a.backBtn&&a.backBtn.addEventListener("click",P),I(),S(),document.addEventListener("click",()=>{e.bgm&&e.bgm.paused&&!e.gameStarted&&e.bgm.play().catch(()=>{})},{once:!0})}function S(){e.bgm||(e.bgm=new Audio("/æ­ŒèˆžåŽ…èƒŒæ™¯éŸ³ä¹.MP3"),e.bgm.loop=!0,e.bgm.volume=.4,e.bgm.play().catch(t=>console.log("Autoplay blocked",t)))}function v(){console.log("Game Starting..."),d.ctx&&d.ctx.state==="suspended"&&d.ctx.resume().catch(()=>{}),e.bgm&&e.bgm.paused&&e.bgm.play().catch(()=>{}),a.startScreen.classList.add("hidden"),e.gameStarted=!0,a.controlsHint.classList.remove("hidden"),k();const t=document.getElementById("game-container"),s=(t.clientWidth-m.PLAYER_SIZE)/2,i=t.clientHeight-m.PLAYER_SIZE-20;e.playerPos={x:s,y:i},g(),L()}function I(){window.addEventListener("keydown",t=>{e.keys[t.key]=!0,t.key==="Enter"&&(e.gameStarted||v()),(t.key==="Escape"||t.key==="Backspace")&&e.currentScene!=="lobby"&&P()}),window.addEventListener("keyup",t=>{e.keys[t.key]=!1,l.classList.remove("walking")})}function L(){requestAnimationFrame(L),!e.isTransitioning&&(e.currentScene==="lobby"?(E(),O()):(E(),C()))}function E(){let t=!1;const s=m.SPEED,i=e.keys.ArrowLeft||e.keys.a,n=e.keys.ArrowRight||e.keys.d;(e.keys.ArrowUp||e.keys.w)&&(e.playerPos.y-=s,t=!0),(e.keys.ArrowDown||e.keys.s)&&(e.playerPos.y+=s,t=!0),i&&(e.playerPos.x-=s,t=!0),n&&(e.playerPos.x+=s,t=!0),a.keyLeft&&(i?a.keyLeft.classList.add("active"):a.keyLeft.classList.remove("active"),n?a.keyRight.classList.add("active"):a.keyRight.classList.remove("active"));const o=document.getElementById("game-container"),r=o.clientWidth-m.PLAYER_SIZE,c=o.clientHeight-m.PLAYER_SIZE;let h=o.clientHeight*.7;typeof e.currentScene=="number"&&(h=o.clientHeight*.6),e.playerPos.x=Math.max(0,Math.min(e.playerPos.x,r)),e.playerPos.y=Math.max(h,Math.min(e.playerPos.y,c)),g(),t?l.classList.add("walking"):l.classList.remove("walking")}function g(){l.style.left=`${e.playerPos.x}px`,l.style.top=`${e.playerPos.y}px`,l.style.transform="none"}function R(){e.rhythm.score=0,e.rhythm.combo=0,e.rhythm.notes=[],e.rhythm.frameCount=0,e.rhythm.isPlaying=!0,p("normal"),a.rhythmHud.classList.remove("hidden"),a.vControls&&a.vControls.classList.remove("hidden"),u(),l.style.display="block",l.style.zIndex=60}function B(){e.rhythm.isPlaying=!1,a.rhythmHud.classList.add("hidden"),a.vControls&&a.vControls.classList.add("hidden"),p("normal"),e.rhythm.notes.forEach(t=>t.el.remove()),e.rhythm.notes=[]}function p(t){e.rhythm.powerUp=t,l.classList.remove("big","star"),t==="big"?(l.classList.add("big"),e.rhythm.powerUpTimer=performance.now()+15e3,y("BIG MODE!","#e50914")):t==="star"&&(l.classList.add("star"),e.rhythm.powerUpTimer=performance.now()+8e3,y("INVINCIBLE!","#ffd700"))}function C(){if(!e.rhythm.isPlaying)return;e.rhythm.frameCount++,e.rhythm.powerUp!=="normal"&&performance.now()>e.rhythm.powerUpTimer&&p("normal"),e.rhythm.frameCount%m.SPAWN_RATE===0&&A(),e.rhythm.speedMod<1&&performance.now()>e.rhythm.freezeTimer&&(e.rhythm.speedMod=1);const s=document.getElementById("game-container").clientHeight;for(let i=e.rhythm.notes.length-1;i>=0;i--){const n=e.rhythm.notes[i];let o=n.speed*(e.rhythm.speedMod||1);if(n.y+=o,n.el.style.top=`${n.y}px`,n.y>s){n.type!=="bomb"?w(n,!1):n.el.remove(),e.rhythm.notes.splice(i,1);continue}M(n)&&(w(n,!0),e.rhythm.notes.splice(i,1))}}function A(){const t=document.getElementById("game-container"),s=document.createElement("div");s.className="note";const i=Math.random();let n="style-1",o="ðŸŽµ",r=0;i<.03?(n="ice",o="â„ï¸",r=1):i<.08?(n="mushroom",o="ðŸ„",r=2):i<.13?(n="star",o="â­",r=3):i<.2?(n="bomb",o="ðŸ’£",r=0):i<.3?(n="coin",o="ðŸª™",r=2):i<.65&&(n="style-2",o="â˜…"),s.classList.add(n),s.textContent=o;const c=t.clientWidth-50,h=Math.random()*(c-50)+25;s.style.left=`${h}px`,s.style.top="-70px",f.appendChild(s),e.rhythm.notes.push({el:s,x:h,y:-70,speed:m.NOTE_SPEED+r+Math.random()*2,type:n,width:70,height:70})}function M(t){const s=e.playerPos.x,i=e.playerPos.y;let n=m.PLAYER_SIZE,o=5;e.rhythm.powerUp==="big"&&(o=-15,n=n+30);const r={l:t.x+10,r:t.x+t.width-10,t:t.y+10,b:t.y+t.height-10},c={l:s+o,r:s+n-o,t:i+20,b:i+n};return!(c.r<r.l||c.l>r.r||c.b<r.t||c.t>r.b)}function w(t,s){if(s){if(t.type==="bomb"){e.rhythm.powerUp==="star"?(e.rhythm.score+=200,d.playSuccess(),y("DESTROY!","#eda002"),x(t.x,t.y)):(e.rhythm.score=Math.max(0,e.rhythm.score-500),e.rhythm.combo=0,d.playFail(),y("BOOM!!","#f00"),document.body.classList.add("shake"),setTimeout(()=>document.body.classList.remove("shake"),500),e.rhythm.powerUp==="big"&&p("normal")),t.el.remove(),u();return}let i=100,n="PERFECT!",o="#0f0";t.type==="coin"&&(i=300,n="RICH!",o="#ffd700"),e.rhythm.powerUp==="star"&&(i*=2),e.rhythm.score+=i+e.rhythm.combo*10,e.rhythm.combo++,d.playSuccess(),t.el.remove(),t.type==="mushroom"&&(p("big"),n="GROW!"),t.type==="star"&&(p("star"),n="STAR!"),t.type==="ice"&&(e.rhythm.speedMod=.5,e.rhythm.freezeTimer=performance.now()+5e3,n="FREEZE!",o="#a0eaff"),x(t.x,t.y),y(n,o)}else e.rhythm.powerUp!=="normal"?(p("normal"),d.playFail(),y("POWER DOWN","#f00")):(e.rhythm.combo=0,d.playFail(),y("MISS","#f00")),t.el.remove();u()}function x(t,s){const i=document.createElement("div");i.className="hit-effect",i.style.left=`${t-30}px`,i.style.top=`${s-30}px`,f.appendChild(i),setTimeout(()=>i.remove(),500)}function y(t,s){a.msg.textContent=t,a.msg.style.color=s,a.msg.classList.remove("pop"),a.msg.offsetWidth,a.msg.classList.add("pop")}function u(){a.score.textContent=e.rhythm.score,a.combo.textContent=e.rhythm.combo}function k(){f.innerHTML="",e.bgm&&e.bgm.play().catch(i=>console.log("BGM Play Error:",i));const t=document.getElementById("game-container");t&&(e.playerPos.x=(t.clientWidth-m.PLAYER_SIZE)/2,e.playerPos.y=t.clientHeight-m.PLAYER_SIZE-20,g());const s=[{left:"5%",top:"35%",width:"12%",height:"55%",transform:"perspective(1000px) rotateY(25deg)"},{left:"23%",top:"48%",width:"10%",height:"33%",transform:"perspective(1000px) rotateY(15deg)"},{left:"40%",top:"51%",width:"8.5%",height:"26%",transform:"none"},{left:"52%",top:"51%",width:"8.5%",height:"26%",transform:"none"},{left:"69%",top:"52%",width:"8%",height:"28%",transform:"perspective(1000px) rotateY(-15deg)"},{left:"86%",top:"46%",width:"10%",height:"38%",transform:"perspective(1000px) rotateY(-25deg)"}];m.ROOMS.forEach((i,n)=>{const o=document.createElement("div");o.className="door",o.dataset.roomId=i.id;const r=s[n]||{};o.style.left=r.left,o.style.top=r.top,r.width&&(o.style.width=r.width),r.height&&(o.style.height=r.height),r.transform&&(o.style.transform=r.transform);const c=document.createElement("div");c.className="plate",c.textContent=`${i.id}`,o.appendChild(c),f.appendChild(o)}),l.style.display="block",a.rhythmHud.classList.add("hidden")}function O(){const t=l.getBoundingClientRect();document.querySelectorAll(".door").forEach(i=>{const n=i.getBoundingClientRect(),o=parseInt(i.dataset.roomId),r=t.left<n.right&&t.right>n.left,h=document.getElementById("game-container").clientHeight*.7;let b=t.top<h+50;(o===3||o===4)&&(b=t.bottom<n.bottom+20),r&&b&&H(o,i)})}async function H(t,s){if(e.isTransitioning)return;e.isTransitioning=!0,s&&(s.classList.add("open"),d.playClick(),await new Promise(n=>setTimeout(n,500))),e.currentScene=t,a.transition.classList.remove("hidden"),d.playDiskChange(),e.bgm&&e.bgm.pause(),a.controlsHint.classList.add("hidden"),await new Promise(n=>setTimeout(n,2e3));const i=m.ROOMS.find(n=>n.id===t);N(i),a.transition.classList.add("hidden"),e.isTransitioning=!1}function N(t){f.innerHTML="",l.style.display="block";const s=document.createElement("video");s.src=`/videos/${t.video}`,s.style.width="100%",s.style.height="100%",s.style.objectFit="cover",s.style.objectPosition="center 40%",s.autoplay=!0,s.loop=!0,s.controls=!1,f.appendChild(s),R()}function P(){B(),a.transition.classList.remove("hidden"),setTimeout(()=>{e.currentScene="lobby",k(),a.transition.classList.add("hidden"),a.controlsHint.classList.remove("hidden")},1e3)}const d={ctx:new(window.AudioContext||window.webkitAudioContext),playTone(t,s,i){this.ctx.state==="suspended"&&this.ctx.resume();const n=this.ctx.createOscillator(),o=this.ctx.createGain();n.type=s,n.frequency.setValueAtTime(t,this.ctx.currentTime),o.gain.setValueAtTime(.1,this.ctx.currentTime),o.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+i),n.connect(o),o.connect(this.ctx.destination),n.start(),n.stop(this.ctx.currentTime+i)},playNoise(t){this.ctx.state==="suspended"&&this.ctx.resume();const s=this.ctx.sampleRate*t,i=this.ctx.createBuffer(1,s,this.ctx.sampleRate),n=i.getChannelData(0);for(let c=0;c<s;c++)n[c]=Math.random()*2-1;const o=this.ctx.createBufferSource();o.buffer=i;const r=this.ctx.createGain();r.gain.setValueAtTime(.05,this.ctx.currentTime),r.gain.linearRampToValueAtTime(0,this.ctx.currentTime+t),o.connect(r),r.connect(this.ctx.destination),o.start()},playSuccess(){this.playTone(600,"sine",.1),setTimeout(()=>this.playTone(800,"sine",.2),100)},playFail(){this.playTone(150,"sawtooth",.3)},playDiskChange(){this.playNoise(1.5),this.playTone(50,"square",.1)},playClick(){this.playTone(400,"triangle",.05)}};document.querySelectorAll("button").forEach(t=>{t.addEventListener("click",()=>d.playClick())});T();
