(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function s(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(o){if(o.ep)return;o.ep=!0;const r=s(o);fetch(o.href,r)}})();const m={SPEED:10,PLAYER_SIZE:48,ROOMS:[{id:1,name:"è¿·è¿­é¦™",video:"è¿·è¿­é¦™.mp4",answers:["è¿·è¿­é¦™","å‘¨æ°ä¼¦"],style:"jazz"},{id:2,name:"é¾™å·é£Ž",video:"é¾™å·é£Ž.mp4",answers:["é¾™å·é£Ž","å‘¨æ°ä¼¦"],style:"pop"},{id:3,name:"æœˆäº®ä»£è¡¨è°çš„å¿ƒ",video:"æœˆäº®ä»£è¡¨è°çš„å¿ƒ.mp4",answers:["æœˆäº®ä»£è¡¨è°çš„å¿ƒ","é™¶å–†"],style:"rnb"},{id:4,name:"åƒå¹´ç­‰ä¸€å›ž",video:"åƒå¹´ç­‰ä¸€å›ž.mp4",answers:["åƒå¹´ç­‰ä¸€å›ž","é«˜èƒœç¾Ž"],style:"classic-cn"},{id:5,name:"ä¸€ç”Ÿæ‰€çˆ±",video:"ä¸€ç”Ÿæ‰€çˆ±.mp4",answers:["ä¸€ç”Ÿæ‰€çˆ±","å¢å† å»·"],style:"hk"},{id:6,name:"æ•¢é—®è·¯åœ¨ä½•æ–¹",video:"æ•¢é—®è·¯åœ¨ä½•æ–¹.mp4",answers:["æ•¢é—®è·¯åœ¨ä½•æ–¹","è’‹å¤§ä¸º"],style:"folk"}],NOTE_SPEED:3,SPAWN_RATE:100},e={currentScene:"lobby",playerPos:{x:window.innerWidth/2,y:window.innerHeight/2},keys:{},isTransitioning:!1,gameStarted:!1,bgm:null,rhythm:{score:0,combo:0,notes:[],frameCount:0,isPlaying:!1,powerUp:"normal",powerUpTimer:0,speedMod:1,freezeTimer:0}},l=document.getElementById("player"),p=document.getElementById("scene-layer"),c={startScreen:document.getElementById("start-screen"),startBtn:document.getElementById("start-btn"),controlsHint:document.getElementById("controls-hint"),rhythmHud:document.getElementById("rhythm-hud"),score:document.getElementById("rhythm-score"),combo:document.getElementById("rhythm-combo"),msg:document.getElementById("rhythm-message"),transition:document.getElementById("transition-overlay"),scoreBoard:document.getElementById("score-board")};function T(){c.startBtn.addEventListener("click",L),I(),S(),document.addEventListener("click",()=>{e.bgm&&e.bgm.paused&&!e.gameStarted&&e.bgm.play().catch(()=>{})},{once:!0})}function S(){e.bgm||(e.bgm=new Audio("/æ­ŒèˆžåŽ…èƒŒæ™¯éŸ³ä¹.MP3"),e.bgm.loop=!0,e.bgm.volume=.4,e.bgm.play().catch(t=>console.log("Autoplay blocked",t)))}function L(){console.log("Game Starting..."),d.ctx&&d.ctx.state==="suspended"&&d.ctx.resume().catch(()=>{}),e.bgm&&e.bgm.paused&&e.bgm.play().catch(()=>{}),c.startScreen.classList.add("hidden"),e.gameStarted=!0,c.controlsHint.classList.remove("hidden"),P();const t=document.getElementById("game-container"),i=(t.clientWidth-m.PLAYER_SIZE)/2,s=t.clientHeight-m.PLAYER_SIZE-20;e.playerPos={x:i,y:s},g(),v()}function I(){window.addEventListener("keydown",t=>{e.keys[t.key]=!0,t.key==="Enter"&&(e.gameStarted||L()),t.key==="Escape"&&e.currentScene!=="lobby"&&N()}),window.addEventListener("keyup",t=>{e.keys[t.key]=!1,l.classList.remove("walking")})}function v(){requestAnimationFrame(v),!e.isTransitioning&&(e.currentScene==="lobby"?(E(),M()):(E(),C()))}function E(){let t=!1;const i=m.SPEED;(e.keys.ArrowUp||e.keys.w)&&(e.playerPos.y-=i,t=!0),(e.keys.ArrowDown||e.keys.s)&&(e.playerPos.y+=i,t=!0),(e.keys.ArrowLeft||e.keys.a)&&(e.playerPos.x-=i,t=!0),(e.keys.ArrowRight||e.keys.d)&&(e.playerPos.x+=i,t=!0);const s=document.getElementById("game-container"),n=s.clientWidth-m.PLAYER_SIZE,o=s.clientHeight-m.PLAYER_SIZE;let r=s.clientHeight*.7;typeof e.currentScene=="number"&&(r=s.clientHeight*.6),e.playerPos.x=Math.max(0,Math.min(e.playerPos.x,n)),e.playerPos.y=Math.max(r,Math.min(e.playerPos.y,o)),g(),t?l.classList.add("walking"):l.classList.remove("walking")}function g(){l.style.left=`${e.playerPos.x}px`,l.style.top=`${e.playerPos.y}px`,l.style.transform="none"}function k(){e.rhythm.score=0,e.rhythm.combo=0,e.rhythm.notes=[],e.rhythm.frameCount=0,e.rhythm.isPlaying=!0,y("normal"),c.rhythmHud.classList.remove("hidden"),u(),l.style.display="block",l.style.zIndex=60}function R(){e.rhythm.isPlaying=!1,c.rhythmHud.classList.add("hidden"),y("normal"),e.rhythm.notes.forEach(t=>t.el.remove()),e.rhythm.notes=[]}function y(t){e.rhythm.powerUp=t,l.classList.remove("big","star"),t==="big"?(l.classList.add("big"),e.rhythm.powerUpTimer=performance.now()+15e3,h("BIG MODE!","#e50914")):t==="star"&&(l.classList.add("star"),e.rhythm.powerUpTimer=performance.now()+8e3,h("INVINCIBLE!","#ffd700"))}function C(){if(!e.rhythm.isPlaying)return;e.rhythm.frameCount++,e.rhythm.powerUp!=="normal"&&performance.now()>e.rhythm.powerUpTimer&&y("normal"),e.rhythm.frameCount%m.SPAWN_RATE===0&&A(),e.rhythm.speedMod<1&&performance.now()>e.rhythm.freezeTimer&&(e.rhythm.speedMod=1);const i=document.getElementById("game-container").clientHeight;for(let s=e.rhythm.notes.length-1;s>=0;s--){const n=e.rhythm.notes[s];let o=n.speed*(e.rhythm.speedMod||1);if(n.y+=o,n.el.style.top=`${n.y}px`,n.y>i){n.type!=="bomb"?w(n,!1):n.el.remove(),e.rhythm.notes.splice(s,1);continue}B(n)&&(w(n,!0),e.rhythm.notes.splice(s,1))}}function A(){const t=document.getElementById("game-container"),i=document.createElement("div");i.className="note";const s=Math.random();let n="style-1",o="ðŸŽµ",r=0;s<.03?(n="ice",o="â„ï¸",r=1):s<.08?(n="mushroom",o="ðŸ„",r=2):s<.13?(n="star",o="â­",r=3):s<.2?(n="bomb",o="ðŸ’£",r=0):s<.3?(n="coin",o="ðŸª™",r=2):s<.65&&(n="style-2",o="â˜…"),i.classList.add(n),i.textContent=o;const a=t.clientWidth-50,f=Math.random()*(a-50)+25;i.style.left=`${f}px`,i.style.top="-50px",p.appendChild(i),e.rhythm.notes.push({el:i,x:f,y:-50,speed:m.NOTE_SPEED+r+Math.random()*2,type:n,width:40,height:40})}function B(t){const i=e.playerPos.x,s=e.playerPos.y;let n=m.PLAYER_SIZE,o=5;e.rhythm.powerUp==="big"&&(o=-15,n=n+30);const r={l:t.x,r:t.x+t.width,t:t.y,b:t.y+t.height},a={l:i+o,r:i+n-o,t:s+20,b:s+n};return!(a.r<r.l||a.l>r.r||a.b<r.t||a.t>r.b)}function w(t,i){if(i){if(t.type==="bomb"){e.rhythm.powerUp==="star"?(e.rhythm.score+=200,d.playSuccess(),h("DESTROY!","#eda002"),x(t.x,t.y)):(e.rhythm.score=Math.max(0,e.rhythm.score-500),e.rhythm.combo=0,d.playFail(),h("BOOM!!","#f00"),document.body.classList.add("shake"),setTimeout(()=>document.body.classList.remove("shake"),500),e.rhythm.powerUp==="big"&&y("normal")),t.el.remove(),u();return}let s=100,n="PERFECT!",o="#0f0";t.type==="coin"&&(s=300,n="RICH!",o="#ffd700"),e.rhythm.powerUp==="star"&&(s*=2),e.rhythm.score+=s+e.rhythm.combo*10,e.rhythm.combo++,d.playSuccess(),t.el.remove(),t.type==="mushroom"&&(y("big"),n="GROW!"),t.type==="star"&&(y("star"),n="STAR!"),t.type==="ice"&&(e.rhythm.speedMod=.5,e.rhythm.freezeTimer=performance.now()+5e3,n="FREEZE!",o="#a0eaff"),x(t.x,t.y),h(n,o)}else e.rhythm.powerUp!=="normal"?(y("normal"),d.playFail(),h("POWER DOWN","#f00")):(e.rhythm.combo=0,d.playFail(),h("MISS","#f00")),t.el.remove();u()}function x(t,i){const s=document.createElement("div");s.className="hit-effect",s.style.left=`${t-30}px`,s.style.top=`${i-30}px`,p.appendChild(s),setTimeout(()=>s.remove(),500)}function h(t,i){c.msg.textContent=t,c.msg.style.color=i,c.msg.classList.remove("pop"),c.msg.offsetWidth,c.msg.classList.add("pop")}function u(){c.score.textContent=e.rhythm.score,c.combo.textContent=e.rhythm.combo}function P(){p.innerHTML="",e.bgm&&e.bgm.play().catch(s=>console.log("BGM Play Error:",s));const t=document.getElementById("game-container");t&&(e.playerPos.x=(t.clientWidth-m.PLAYER_SIZE)/2,e.playerPos.y=t.clientHeight-m.PLAYER_SIZE-20,g());const i=[{left:"5%",top:"35%",width:"12%",height:"55%",transform:"perspective(1000px) rotateY(25deg)"},{left:"23%",top:"48%",width:"10%",height:"33%",transform:"perspective(1000px) rotateY(15deg)"},{left:"40%",top:"51%",width:"8.5%",height:"26%",transform:"none"},{left:"52%",top:"51%",width:"8.5%",height:"26%",transform:"none"},{left:"69%",top:"52%",width:"8%",height:"28%",transform:"perspective(1000px) rotateY(-15deg)"},{left:"86%",top:"46%",width:"10%",height:"38%",transform:"perspective(1000px) rotateY(-25deg)"}];m.ROOMS.forEach((s,n)=>{const o=document.createElement("div");o.className="door",o.dataset.roomId=s.id;const r=i[n]||{};o.style.left=r.left,o.style.top=r.top,r.width&&(o.style.width=r.width),r.height&&(o.style.height=r.height),r.transform&&(o.style.transform=r.transform);const a=document.createElement("div");a.className="plate",a.textContent=`${s.id}`,o.appendChild(a),p.appendChild(o)}),l.style.display="block",c.rhythmHud.classList.add("hidden")}function M(){const t=l.getBoundingClientRect();document.querySelectorAll(".door").forEach(s=>{const n=s.getBoundingClientRect(),o=parseInt(s.dataset.roomId),r=t.left<n.right&&t.right>n.left,f=document.getElementById("game-container").clientHeight*.7;let b=t.top<f+50;(o===3||o===4)&&(b=t.bottom<n.bottom+20),r&&b&&O(o,s)})}async function O(t,i){if(e.isTransitioning)return;e.isTransitioning=!0,i&&(i.classList.add("open"),d.playClick(),await new Promise(n=>setTimeout(n,500))),e.currentScene=t,c.transition.classList.remove("hidden"),d.playDiskChange(),e.bgm&&e.bgm.pause(),c.controlsHint.classList.add("hidden"),await new Promise(n=>setTimeout(n,2e3));const s=m.ROOMS.find(n=>n.id===t);H(s),c.transition.classList.add("hidden"),e.isTransitioning=!1}function H(t){p.innerHTML="",l.style.display="block";const i=document.createElement("video");i.src=`/videos/${t.video}`,i.style.width="100%",i.style.height="100%",i.style.objectFit="cover",i.style.objectPosition="center 40%",i.autoplay=!0,i.loop=!0,i.controls=!1,p.appendChild(i),k()}function N(){R(),c.transition.classList.remove("hidden"),setTimeout(()=>{e.currentScene="lobby",P(),c.transition.classList.add("hidden"),c.controlsHint.classList.remove("hidden")},1e3)}const d={ctx:new(window.AudioContext||window.webkitAudioContext),playTone(t,i,s){this.ctx.state==="suspended"&&this.ctx.resume();const n=this.ctx.createOscillator(),o=this.ctx.createGain();n.type=i,n.frequency.setValueAtTime(t,this.ctx.currentTime),o.gain.setValueAtTime(.1,this.ctx.currentTime),o.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+s),n.connect(o),o.connect(this.ctx.destination),n.start(),n.stop(this.ctx.currentTime+s)},playNoise(t){this.ctx.state==="suspended"&&this.ctx.resume();const i=this.ctx.sampleRate*t,s=this.ctx.createBuffer(1,i,this.ctx.sampleRate),n=s.getChannelData(0);for(let a=0;a<i;a++)n[a]=Math.random()*2-1;const o=this.ctx.createBufferSource();o.buffer=s;const r=this.ctx.createGain();r.gain.setValueAtTime(.05,this.ctx.currentTime),r.gain.linearRampToValueAtTime(0,this.ctx.currentTime+t),o.connect(r),r.connect(this.ctx.destination),o.start()},playSuccess(){this.playTone(600,"sine",.1),setTimeout(()=>this.playTone(800,"sine",.2),100)},playFail(){this.playTone(150,"sawtooth",.3)},playDiskChange(){this.playNoise(1.5),this.playTone(50,"square",.1)},playClick(){this.playTone(400,"triangle",.05)}};document.querySelectorAll("button").forEach(t=>{t.addEventListener("click",()=>d.playClick())});T();
